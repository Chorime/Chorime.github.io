<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Add this to the head section of your HTML -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <title>Kanji</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      background: #f0f0f0;
      overflow: auto; 
    }

    .hidden { display: none; }

    /* Menu */
    #menu {
      text-align: center;
    }

    #menu h1 {
      margin-bottom: 20px;
    }

    .menu-button {
      display: block;
      margin: 10px auto;
      padding: 12px 20px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      background: #1976d2;
      color: white;
      cursor: pointer;
      width: 250px;
    }

    /* Flashcard */
    #flashcard-screen {
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .card-container {
      perspective: 1000px;
      width: 300px;
      height: 200px;
      margin-bottom: 20px;
      cursor: pointer;
    }

    .card {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.6s;
    }

    .card.flipped {
      transform: rotateY(180deg);
    }

    .side {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 72px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      padding: 10px;
      text-align: center;
    }

    .back {
      transform: rotateY(180deg);
      background: white;
      font-size: 24px;
    }

    .buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      padding-top: 10px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    .right {
      background: #4caf50;
      color: white;
    }

    .wrong {
      background: #f44336;
      color: white;
    }

    .back-menu {
      margin-top: 20px;
      background: #888;
      color: white;
    }

    /* Add these styles to your existing CSS */
    .stats-section {
      margin-bottom: 30px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 600px;
      overflow: visible; /* Ensure charts aren't clipped */
    }

    .hidden { 
      display: none !important; /* Add !important to ensure it overrides other styles */
    }

    .stats-section h2 {
      margin-top: 0;
      color: #1976d2;
      font-size: 1.4rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #f5f7fa;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #1976d2;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
    }

    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
      overflow: visible;
      margin: 15px 0;
    }
    
    .chart-container canvas {
      pointer-events: none; /* This prevents the canvas from capturing scroll events */
    }
    
    #categoryChart-container {
      margin-top: 10px; /* Add some space at the top */
    }
    @media (max-width: 768px) {
  .chart-container {
    height: 250px;
  }
  
  #categoryChart-container {
    height: 300px;
  }
}

@media (max-width: 480px) {
  .chart-container {
    height: 220px;
  }
  
  #categoryChart-container {
    height: 270px;
  }
}

    #subcategoryChart {
      height: 300px;
    }

    .overall-stats-container {
  width: 100%;
  max-width: 400px; /* Limit width to prevent overflow */
  margin: 0 auto; /* Center the container */
}

/* Ensure the stats screen has proper spacing */
#stats.screen-container {
   display: block;
  overflow-y: auto;
  max-height: 90vh;
  padding: 20px 15px;
  -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
}

#stats.screen-container h1 {
  margin-top: 0;
  padding-top: 10px;
  position: sticky;
  top: 0;
  background: white;
  z-index: 10;
}
  </style>
</head>
<body>

  <!-- Menu -->
<div id="menu">
  <h1>Kanji</h1>
  <button class="menu-button" onclick="showScreen('tandas')">Tandas</button>
  <button class="menu-button" onclick="showScreen('examenes')">Examen</button>
  <button class="menu-button" onclick="showScreen('subcategorias')">Subcategorias</button>
  <button class="menu-button" onclick="showScreen('review-options')">Repasar Errores</button>
  <button class="menu-button" onclick="showScreen('stats')">Estadisticas</button>
</div>

<div id="tandas" class="hidden" style="text-align:center;">
  <h1>Tandas</h1>
  <button class="menu-button" onclick="StartTanda('1ertanda')">Primera Tanda</button>
  <button class="menu-button" onclick="StartTanda('2datanda')">Segunda Tanda</button>
  <button class="menu-button" onclick="StartTanda('3ertanda')">Tercera Tanda</button>
  <button class="menu-button" onclick="StartTanda('4tatanda')">Cuarta Tanda</button>
  <button class="back-menu" onclick="goBackToMenu()">⬅ Volver al Menu</button>
</div>

<div id="examenes" class="hidden" style="text-align:center;">
  <h1>Examenes</h1>
  <button class="menu-button" onclick="StartExamen('N5')">N5</button>
  <button class="menu-button" onclick="StartExamen('N4')">N4</button>
  <button class="menu-button" onclick="StartExamen('N3')">N3</button>
  <button class="menu-button" onclick="StartExamen('N2')">N2</button>
  <button class="back-menu" onclick="goBackToMenu()">⬅ Volver al Menu</button>
</div>

<div id="subcategorias" class="hidden" style="text-align:center;">
    <h1>Subcategorias</h1>
    <div id="subcategoria-container" class="subcategoria-grid">
      <!-- Dynamic content will be inserted here -->
    </div>
    <button class="back-menu" onclick="goBackToMenu()">⬅ Volver al Menu</button>
  </div>

<!-- Review Options -->
<div id="review-options" class="hidden" style="text-align:center;">
  <h2>Repasar Errores</h2>
  <label for="wrongThreshold">Minimo de errores en los ultimos 5 intentos:</label>
  <select id="wrongThreshold">
    <option value="1">1+</option>
    <option value="2">2+</option>
    <option value="3">3+</option>
    <option value="4">4+</option>
    <option value="5">5 (siempre mal)</option>
  </select>
  <br><br>
  <button class="menu-button" onclick="startReviewWrong()">Empezar Repaso</button>
  <button class="back-menu" onclick="goBackToMenu()">⬅ Volver al Menu</button>
</div>

  <!-- Flashcard Screen -->
  <div id="flashcard-screen" class="hidden">
    <div id="progress-bar" style="margin-bottom:10px; font-size:20px;">1/X</div>
    <div id="history-bar" style="margin-bottom:10px; font-size:20px;"></div> <!-- ✅ History here -->
    <div class="card-container">
      <div class="card" id="flashcard">
        <div class="side front" id="front"></div>
        <div class="side back" id="back"></div>
      </div>
    </div>

    <div class="buttons">
      <button class="right" onclick="markAnswer(true)">Bien</button>
      <button class="wrong" onclick="markAnswer(false)">Mal</button>
    </div>

    <button class="back-menu" onclick="goBackToMenu()">⬅ Volver al Menu</button>
  </div>
  
  <!-- End of Deck Screen -->
<div id="end-screen" class="hidden" style="text-align:center;">
  <h2 id="end-message">Terminaste esta tanda!</h2>
  <h2 id="percentage-right"></h2>
  <button class="menu-button" onclick="goBackToMenu()">⬅ Volver al Menu</button>
</div>

<!-- Stats screen -->
<div id="stats" class="screen-container hidden">
  <div class="stats-section">
  <h2>Overall Performance</h2>
  <div class="overall-stats-container">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="total-cards">0</div>
        <div class="stat-label">Cartas</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="mastered-cards">0</div>
        <div class="stat-label">Perfectas</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="success-rate">0%</div>
        <div class="stat-label">Porcentaje de Correctas</div>
      </div>
    </div>
  </div>
</div>

  <div class="stats-section">
    <h2>Performance por Categoria</h2>
    <div class="chart-container">
      <canvas id="categoryChart" width="400" height="250"></canvas>
    </div>
  </div>

  <div class="stats-section">
    <h2>Performance por Subcategoria</h2>
    <div class="chart-container">
      <canvas id="subcategoryChart" width="400" height="300"></canvas>
    </div>
  </div>

  <div class="stats-section">
    <h2>Performance Reciente</h2>
    <div class="chart-container">
      <canvas id="trendChart" width="400" height="250"></canvas>
    </div>
  </div>

  <button class="back-menu" onclick="goBackToMenu()">⬅ Volver al Menu</button>
</div>


  <script>
    console.log("Chart.js available:", typeof Chart !== "undefined");
  // Card sets
  const allCards = [
          // {word:"", meaning: "",categoria: "",examen: "", subcategoria: ""},

      {word:"晴れ", meaning: "はれ - Despejado",categoria: "1ertanda",examen: "N5", subcategoria: "Clima"},
      {word:"今日", meaning: "きょう - Hoy",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"海", meaning: "うみ - Mar",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"木", meaning: "き - Arbol",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"飲む", meaning: "のむ - Tomar",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"火", meaning: "ひ - Fuego",categoria: "1ertanda",examen: "N4", subcategoria: "Sustantivos"},
      {word:"聞く", meaning: "きく - Escuchar",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"東", meaning: "ひがし - Este",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"土", meaning: "つち - Tierra",categoria: "1ertanda",examen: "N3", subcategoria: "Sustantivos"},
      {word:"半", meaning: "はん - Mitad/Media",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"見る", meaning: "みる - Ver",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"小さい", meaning: "ちいさい - Pequeño",categoria: "1ertanda",examen: "N5", subcategoria: "Adjetivos"},
      {word:"千", meaning: "せん - 1000(Mil)",categoria: "1ertanda",examen: "N5", subcategoria: "Numeros"},
      {word:"大きい", meaning: "おおきい - Grande",categoria: "1ertanda",examen: "N5", subcategoria: "Adjetivos"},
      {word:"百", meaning: "ひゃく - 100(Cien)",categoria: "1ertanda",examen: "N5", subcategoria: "Numeros"},
      {word:"会う", meaning: "あう - Encontrarse",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"魚", meaning: "さかな - Pescado",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"国", meaning: "くに - Pais",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"父", meaning: "ちち - Padre",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"買う", meaning: "かう - Comprar",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"日", meaning: "ひ - Dia",categoria: "1ertanda",examen: "N4", subcategoria: "Sustantivos"},
      {word:"食べる", meaning: "たべる - Comer",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"言う", meaning: "いう - Decir",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"空", meaning: "そら - Cielo",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"山", meaning: "やま - Montaña",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"風", meaning: "かぜ - Viento",categoria: "1ertanda",examen: "N5", subcategoria: "Clima"},
      {word:"秋", meaning: "あき - Otoño",categoria: "1ertanda",examen: "N5", subcategoria: "Clima"},
      {word:"私", meaning: "わたし - Yo",categoria: "1ertanda",examen: "N5", subcategoria: "Extra"},
      {word:"南", meaning: "みなみ - Sur",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"今", meaning: "いま - Ahora",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"話す", meaning: "はなす - Hablar",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"読む", meaning: "よむ - Leer",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"卵", meaning: "たまご - Huevos",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"冬", meaning: "ふゆ - Invierno",categoria: "1ertanda",examen: "N5", subcategoria: "Clima"},
      {word:"人", meaning: "ひと - Persona",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"雨", meaning: "あめ - Lluvia",categoria: "1ertanda",examen: "N5", subcategoria: "Clima"},
      {word:"時", meaning: "じ - Hora",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"本", meaning: "ほん - Libro",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"水", meaning: "みず - Agua",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"雪", meaning: "ゆき - Nieve",categoria: "1ertanda",examen: "N5", subcategoria: "Clima"},
      {word:"肉", meaning: "にく - Carne",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"金", meaning: "かね - Dinero",categoria: "1ertanda",examen: "N3", subcategoria: "Sustantivos"},
      {word:"何", meaning: "なに - Que",categoria: "1ertanda",examen: "N5", subcategoria: "Extra"},
      {word:"円", meaning: "えん - Yenes",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"夏", meaning: "なつ - Verano",categoria: "1ertanda",examen: "N5", subcategoria: "Clima"},
      {word:"読書", meaning: "どくしょ - Lectura",categoria: "1ertanda",examen: "N3", subcategoria: "Sustantivos"},
      {word:"子ども", meaning: "こども - Niño",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"休む", meaning: "やすむ - Desansar",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"好き", meaning: "すき - Gustar",categoria: "1ertanda",examen: "N5", subcategoria: "Adjetivos"},
      {word:"川", meaning: "かわ - Rio",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"外国", meaning: "がいこく - Pais Extranjero",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"来る", meaning: "くる - Venir",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"花", meaning: "はな - Flor",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"北", meaning: "きた - Norte",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"月", meaning: "つき - Luna",categoria: "1ertanda",examen: "N3", subcategoria: "Sustantivos"},
      {word:"西", meaning: "にし - Oeste",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"口", meaning: "くち - Boca",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"春", meaning: "はる - Primavera",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"女", meaning: "おんな - Mujer",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"天気", meaning: "てんき - Clima",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"分", meaning: "ふん - Minuto",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"書く", meaning: "かく - Escribir",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"万", meaning: "まん - 10.000 (Diezmil)",categoria: "1ertanda",examen: "N5", subcategoria: "Numeros"},
      {word:"古い", meaning: "ふるい - Viejo",categoria: "1ertanda",examen: "N5", subcategoria: "Adjetivos"},
      {word:"男", meaning: "おとこ - Hombre",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"行く", meaning: "いく - Ir",categoria: "1ertanda",examen: "N5", subcategoria: "Verbos"},
      {word:"母", meaning: "はは - Madre",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"昼", meaning: "ひる - Mediodia",categoria: "1ertanda",examen: "N5", subcategoria: "Sustantivos"},
      

      {word: "町", meaning: "まち - Ciudad", categoria: "2datanda" ,examen: "N5", subcategoria: "Ciudad" },
      {word: "少", meaning: "すくない - Poco" ,categoria: "2datanda" , examen: "N5", subcategoria: "Adjetivos"},
      {word: "青い", meaning: "あおい - Azul" ,categoria: "2datanda" , examen: "N5", subcategoria: "Colores"},
      {word:"仕事", meaning: "しごと - Trabajo ",categoria: "2datanda",examen: "N5", subcategoria: "Profesiones"},
      {word:"広い", meaning: "ひろい - Amplio",categoria: "2datanda",examen: "N5", subcategoria: "Adjetivos"},
      {word:"乗る", meaning: "のる - Subirse",categoria: "2datanda",examen: "N5", subcategoria: "Verbos"},
      {word:"時間", meaning: "じかん - Hora/Tiempo",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"夜", meaning: "よる - Noche",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"赤い", meaning: "あかい - Rojo",categoria: "2datanda",examen: "N5", subcategoria: "Colores"},
      {word:"店", meaning: "みせ - Tienda",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"朝", meaning: " あさ - La mañana",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"道", meaning: "みち - Camino",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"高い", meaning: "たかい - Alto/Caro",categoria: "2datanda",examen: "N5", subcategoria: "Adjetivos"},
      {word:"待つ", meaning: "まつ - Esperar",categoria: "2datanda",examen: "N5", subcategoria: "Verbos"},
      {word:"右", meaning: "みぎ - Derecha",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"左", meaning: "ひだり",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"黒い", meaning: "くろい - Negro",categoria: "2datanda",examen: "N5", subcategoria: "Colores"},
      {word:"前", meaning: "まえ - Antes/Adelante",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"止まる", meaning: "とまる - Detenerse",categoria: "2datanda",examen: "N5", subcategoria: "Verbos"},
      {word:"人気", meaning: "にんき - Popular",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"出かける", meaning: "でかける - Salir",categoria: "2datanda",examen: "N5", subcategoria: "Verbos"},
      {word:"年", meaning: "ねん - Año",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"後", meaning: "あと - Despues",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"駅", meaning: "えき - Estacion",categoria: "2datanda",examen: "N5", subcategoria: "Sustantivos"},
      {word:"多い", meaning: "おおい - Mucho",categoria: "2datanda",examen: "N5", subcategoria: "Adjetivos"},
      {word:"食事", meaning: "しょくじ - Comida",categoria: "2datanda",examen: "N3", subcategoria: "Sustantivos"},
      {word:"安い", meaning: "やすい - Barato",categoria: "2datanda",examen: "N5", subcategoria: "Adjetivos"},
      {word:"白い", meaning: "しろい - Blanco",categoria: "2datanda",examen: "N5", subcategoria: "Colores"},
      {word:"場所", meaning: "ばしょ - Lugar",categoria: "2datanda",examen: "N4", subcategoria: "Sustantivos"},
      {word:"通り", meaning: "とおり - Calle",categoria: "2datanda",examen: "N3", subcategoria: "Sustantivos"},
    
    
      {word: "taberu", meaning: "to eat",categoria: "3ertanda" ,examen: "N5", subcategoria: "prueba"},
      {word: "nomu", meaning: "to drink",categoria: "3ertanda" ,examen: "N5", subcategoria: "prueba"},
      {word: "miru", meaning: "to see",categoria: "3ertanda" ,examen: "N5", subcategoria: "prueba"}
    
  ];

  let currentSet = [];
  // let cards = [];
  let currentIndex = 0;
  let currentCard = null;
  let reviewWrongMode = false;
  let rightAnswers = 0;
  let categoryChartInstance = null;
  let subcategoryChartInstance = null;
  let trendChartInstance = null;

  const flashcard = document.getElementById("flashcard");
  const front = document.getElementById("front");
  const back = document.getElementById("back");

  function startSet(setName) {
    currentSet = setName;
    cards = cardSets[setName];
    reviewWrongMode = false;
    shuffle(cards);
    currentIndex = 0;
    showScreen("flashcard-screen");
    loadCard();
  }

  function getUniqueSubcategorias() {
    const subcategorias = allCards.map(card => card.subcategoria);
    return [...new Set(subcategorias)].sort();
  }

  function generateSubcategoriaButtons() {
    const container = document.getElementById("subcategoria-container");
    container.innerHTML = ""; // Clear previous content
    
    const subcategorias = getUniqueSubcategorias();
    
    if (subcategorias.length === 0) {
      container.innerHTML = "<p>No subcategories found</p>";
      return;
    }
    
    subcategorias.forEach(subcategoria => {
      const button = document.createElement("button");
      button.className = "subcategoria-button";
      button.textContent = subcategoria.charAt(0).toUpperCase() + subcategoria.slice(1);
      button.onclick = () => StartSubcategoria(subcategoria);
      container.appendChild(button);
    });
  }


  function StartTanda(categoria){
    currentSet = allCards.filter(c => c.categoria === categoria);
    shuffle(currentSet);
    currentIndex = 0;
    reviewWrongMode = false;
    showScreen("flashcard-screen");
    loadCard();
  }
    function StartExamen(examen){
    currentSet = allCards.filter(c => c.examen === examen);
    shuffle(currentSet);
    currentIndex = 0;
    reviewWrongMode = false;
    showScreen("flashcard-screen");
    loadCard();
  }
  function StartSubcategoria(subcategoria) {
    currentSet = allCards.filter(c => c.subcategoria === subcategoria);
    shuffle(currentSet);
    currentIndex = 0;
    reviewWrongMode = false;
    showScreen("flashcard-screen");
    loadCard();
  }

  
function startReviewWrong() {
  const threshold = parseInt(document.getElementById("wrongThreshold").value, 10);
  reviewWrongMode = true;
  currentSet = filterWrongCards(threshold);

  if (currentSet.length === 0) {
    alert("Ninguna carta coincide con los parametros de busqueda!");
    return;
  }

  
  shuffle(currentSet);
  currentIndex = 0;

  showScreen("flashcard-screen");
  loadCard();
}

  function loadCard() {
    if (currentSet.length === 0) {
      front.textContent = "No cards!";
      back.textContent = "";
      document.getElementById("history-bar").textContent = "";
      return;
    }
    document.getElementById("progress-bar").textContent = (currentIndex+1) + "/" + currentSet.length;
    if (!flashcard.classList.contains('flipped')) {
    currentCard = currentSet[currentIndex];
    front.textContent = currentCard.word;
    back.textContent = currentCard.meaning;

    // show meaning + recent history
    const history = getHistory(currentCard.word);
    const displayHistory = history.map(item => {
    if (typeof item === 'string') {
      return item === "R" ? "✅" : "❌";
    } else {
      return item.result === "R" ? "✅" : "❌";
    }
    });
    document.getElementById("history-bar").textContent =
    "History: " + displayHistory.join(" ");
    }
    else{
    flashcard.classList.remove("flipped");
    currentCard = currentSet[currentIndex];
    front.textContent = currentCard.word;
    // show meaning + recent history
    const history = getHistory(currentCard.word);
      const displayHistory = history.map(item => {
    if (typeof item === 'string') {
      return item === "R" ? "✅" : "❌";
    } else {
      return item.result === "R" ? "✅" : "❌";
    }
    });
    document.getElementById("history-bar").textContent =
    "History: " + displayHistory.join(" ");
    setTimeout(function() {
    back.textContent = currentCard.meaning;
    }, 600); // 600 milliseconds = 0,6 seconds (lo que tarda en girar la carta)
    }
  }

  flashcard.addEventListener("click", () => {
    flashcard.classList.toggle("flipped");
  });

  function markAnswer(isRight) {
    const cardId = currentCard.word;
    let wrongWords = JSON.parse(localStorage.getItem("wrongWords")) || [];

    // Update wrongWords list
    if (isRight) {
      wrongWords = wrongWords.filter(c => c.word !== currentCard.word);
      rightAnswers++;
    } else {
      if (!wrongWords.find(c => c.word === currentCard.word)) {
        wrongWords.push(currentCard);
      }
    }
    localStorage.setItem("wrongWords", JSON.stringify(wrongWords));

    // Update history
    let history = getHistory(cardId);
    history.push({
    result: isRight ? "R" : "W",
    timestamp: new Date().toISOString()
    });
    if (history.length > 10) history.shift(); // keep last 10
    localStorage.setItem("history_" + cardId, JSON.stringify(history));

    currentIndex++;
    if (currentIndex >= currentSet.length) {
    document.getElementById("percentage-right").textContent = "Hiciste " + Math.trunc((rightAnswers/currentSet.length)*100) + "% bien";
    showScreen("end-screen");
    rightAnswers = 0;
    document.getElementById("end-message").textContent =
      reviewWrongMode ? "Terminaste de revisar las cartas en las que te confundiste!" : "Terminaste este Set!";
    } else {
    loadCard();
    }
  }

  function loadAllWrongCards() {
    return JSON.parse(localStorage.getItem("wrongWords")) || [];
  }
  
function filterWrongCards(threshold) {
  // const allCards = Object.values(cardSets).flat(); // flatten all sets
  return allCards.filter(card => {
    const history = getHistory(card.word);
    const wrongs = history.filter(r => r === "W").length;
    return wrongs >= threshold;
  });
}

  function getHistory(cardId) {
    const history =  JSON.parse(localStorage.getItem("history_" + cardId)) || [];
    if (history.length > 0 && typeof history[0] === 'string') {
    const newHistory = history.map(result => ({
      result: result,
      timestamp: new Date().toISOString() // Approximate timestamp
    }));
    localStorage.setItem("history_" + cardId, JSON.stringify(newHistory));
    return newHistory;
  }
  
  return history;
  }


  function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  }

  function goBackToMenu() {
    rightAnswers = 0;
    showScreen("menu");
  }

  function showScreen(id) {
    if (document.getElementById("stats") && !document.getElementById("stats").classList.contains("hidden")) {
    destroyAllCharts();
    }
    if (id === "subcategorias") {
      generateSubcategoriaButtons();
    }
    if (id === "stats") {
      resetCanvases();
      displayStats();
      setTimeout(enableStatsScrolling, 500);
      setTimeout(adjustChartLayout, 300);
    }
  ["menu","tandas","examenes","stats","subcategorias","flashcard-screen", "review-options", "end-screen"].forEach(s =>
    document.getElementById(s).classList.add("hidden")
  );
  document.getElementById(id).classList.remove("hidden");
  }
  
  function resetCanvases() {
  // Get all canvas elements
  const canvases = document.querySelectorAll('canvas');
  
  // Replace each canvas with a clone to reset it completely
  canvases.forEach(canvas => {
    const clone = canvas.cloneNode(true);
    canvas.parentNode.replaceChild(clone, canvas);
  });
}

function calculateRecentPerformance() {
  const recentTrend = [];
  const today = new Date();
  
  // Create empty entries for the last 7 days
  for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(today.getDate() - i);
    const dateString = date.toISOString().split('T')[0];
    
    recentTrend.push({
      date: dateString,
      correct: 0,
      total: 0
    });
  }
  
  // Collect all answer history across all cards
  let allAnswers = [];
  
  allCards.forEach(card => {
    const history = getHistory(card.word);
    history.forEach(entry => {
      if (entry.timestamp) {
        const answerDate = new Date(entry.timestamp).toISOString().split('T')[0];
        allAnswers.push({
          date: answerDate,
          result: typeof entry === 'string' ? entry : entry.result
        });
      }
    });
  });
  
  // Count answers for each day
  allAnswers.forEach(answer => {
    const trendEntry = recentTrend.find(entry => entry.date === answer.date);
    if (trendEntry) {
      trendEntry.total++;
      if (answer.result === 'R') {
        trendEntry.correct++;
      }
    }
  });
  
  return recentTrend;
}


// Function to calculate statistics
function calculateStats() {
  const stats = {
    byCategory: {},
    bySubcategory: {},
    overall: {
      total: allCards.length,
      mastered: 0,
      successRate: 0,
      totalAttempts: 0,
      correctAttempts: 0
    },
    recentTrend: calculateRecentPerformance()
  };

  // Calculate performance for each card
  allCards.forEach(card => {
    const history = getHistory(card.word);
    const totalAttempts = history.length;
    const correctAttempts = history.filter(item => {
      if (typeof item === 'string') {
        return item === 'R';
      } else {
        return item.result === 'R';
      }
    }).length;
    
    const successRate = totalAttempts > 0 ? (correctAttempts / totalAttempts) * 100 : 0;
    
    // Update overall stats
    stats.overall.totalAttempts += totalAttempts;
    stats.overall.correctAttempts += correctAttempts;
    
    // Update category stats
    if (!stats.byCategory[card.categoria]) {
      stats.byCategory[card.categoria] = { total: 0, attempts: 0, correct: 0, successRate: 0 };
    }
    stats.byCategory[card.categoria].total++;
    stats.byCategory[card.categoria].attempts += totalAttempts;
    stats.byCategory[card.categoria].correct += correctAttempts;
    
    // Update subcategory stats
    if (!stats.bySubcategory[card.subcategoria]) {
      stats.bySubcategory[card.subcategoria] = { total: 0, attempts: 0, correct: 0, successRate: 0 };
    }
    stats.bySubcategory[card.subcategoria].total++;
    stats.bySubcategory[card.subcategoria].attempts += totalAttempts;
    stats.bySubcategory[card.subcategoria].correct += correctAttempts;
    
    // Check if mastered (80% or higher success rate with at least 3 attempts)
    if (successRate >= 80 && totalAttempts >= 3) {
      stats.overall.mastered++;
    }
  });
  
  // Calculate overall success rate
  stats.overall.successRate = stats.overall.totalAttempts > 0 ? 
    (stats.overall.correctAttempts / stats.overall.totalAttempts) * 100 : 0;
  
  // Calculate category success rates
  for (const category in stats.byCategory) {
    stats.byCategory[category].successRate = 
      stats.byCategory[category].attempts > 0 ? 
      (stats.byCategory[category].correct / stats.byCategory[category].attempts) * 100 : 0;
  }
  
  // Calculate subcategory success rates
  for (const subcategory in stats.bySubcategory) {
    stats.bySubcategory[subcategory].successRate = 
      stats.bySubcategory[subcategory].attempts > 0 ? 
      (stats.bySubcategory[subcategory].correct / stats.bySubcategory[subcategory].attempts) * 100 : 0;
  }
  
  return stats;
}

// Add event listeners to handle scrolling on charts
// Alternative approach: Use a passive event listener
function enableStatsScrolling() {
  const statsScreen = document.getElementById('stats');
  if (!statsScreen || statsScreen.classList.contains('hidden')) return;
  
  const charts = statsScreen.querySelectorAll('.chart-container');
  
  charts.forEach(chart => {
    // Add a passive wheel event listener to prevent default behavior
    chart.addEventListener('wheel', function(e) {
      const statsScreen = document.getElementById('stats');
      if (statsScreen && statsScreen.scrollHeight > statsScreen.clientHeight) {
        // Let the event bubble up to the stats screen
        // We don't preventDefault here, we just let it bubble
      }
    }, { passive: true });
  });
  
  // Ensure the stats screen itself is scrollable
  statsScreen.addEventListener('wheel', function(e) {
    // This ensures the stats screen captures the scroll event
  }, { passive: true });
}


// Function to create trend chart
function createTrendChart(trendData) {
  const canvas = document.getElementById('trendChart');
  const ctx = canvas.getContext('2d');
  
  // Check if chart already exists using Chart.js method
  if (Chart.getChart(canvas)) {
    Chart.getChart(canvas).destroy();
  }
  
  // Format dates for display (show as MM/DD)
  const formattedDates = trendData.map(item => {
    const dateParts = item.date.split('-');
    return `${dateParts[1]}/${dateParts[2]}`;
  });
  
  // Calculate success rates
  const successRates = trendData.map(item => 
    item.total > 0 ? (item.correct / item.total) * 100 : 0
  );
  
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: formattedDates,
      datasets: [{
        label: 'Daily Success Rate (%)',
        data: successRates,
        fill: false,
        borderColor: 'rgba(156, 39, 176, 1)',
        backgroundColor: 'rgba(156, 39, 176, 0.2)',
        tension: 0.1,
        pointBackgroundColor: 'rgba(156, 39, 176, 1)',
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Success Rate (%)'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Date'
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const index = context.dataIndex;
              const correct = trendData[index].correct;
              const total = trendData[index].total;
              return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}% (${correct}/${total} correct)`;
            }
          }
        }
      }
    }
  });
}

// Function to display statistics
function displayStats() {
  try {
    // Check if Chart.js is loaded
    if (typeof Chart === "undefined") {
      alert("Chart.js library not loaded. Please check your internet connection.");
      return;
    }
    
    const stats = calculateStats();
    
    // Update overall stats
    document.getElementById('total-cards').textContent = stats.overall.total;
    document.getElementById('mastered-cards').textContent = stats.overall.mastered;
    document.getElementById('success-rate').textContent = `${stats.overall.successRate.toFixed(1)}%`;
    
    // Create category chart
    const categoryCtx = document.getElementById('categoryChart');
    if (categoryCtx) {
      createCategoryChart(stats.byCategory);
    } else {
      console.error("Category chart canvas not found");
    }
    
    // Create subcategory chart
    const subcategoryCtx = document.getElementById('subcategoryChart');
    if (subcategoryCtx) {
      createSubcategoryChart(stats.bySubcategory);
    } else {
      console.error("Subcategory chart canvas not found");
    }

    createTrendChart(stats.recentTrend);
    setTimeout(enableStatsScrolling, 100);
    
  } catch (error) {
    console.error("Error displaying stats:", error);
    alert("Error displaying statistics: " + error.message);
  }
}


// Function to create category chart
function createCategoryChart(categoryData) {
  const canvas = document.getElementById('categoryChart');
  const ctx = canvas.getContext('2d');
  
  // Check if chart already exists using Chart.js method
  if (Chart.getChart(canvas)) {
    Chart.getChart(canvas).destroy();
  }
  
  const categories = Object.keys(categoryData);
  const successRates = categories.map(cat => categoryData[cat].successRate);
  
  return new Chart(ctx, {
    type: 'bar',
    data: {
      labels: categories,
      datasets: [{
        label: 'Success Rate (%)',
        data: successRates,
        backgroundColor: 'rgba(25, 118, 210, 0.7)',
        borderColor: 'rgba(25, 118, 210, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      layout: {
        padding: {
          top: 20,    // Add padding at the top
          bottom: 10,
          left: 10,
          right: 10
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          grace: '5%', // Add grace space at the top
          title: {
            display: true,
            text: 'Success Rate (%)',
            padding: {top: 10, bottom: 10}
          },
          ticks: {
            precision: 0
          }
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 45,
            autoSkip: true,
            maxTicksLimit: 10
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const category = context.label;
              const attempts = categoryData[category].attempts;
              const correct = categoryData[category].correct;
              return `Success: ${context.parsed.y.toFixed(1)}% (${correct}/${attempts} correct)`;
            }
          }
        }
      }
    }
  });
}

function adjustChartLayout() {
  // Wait for the DOM to update
  setTimeout(() => {
    const chartContainers = document.querySelectorAll('.chart-container');
    
    chartContainers.forEach(container => {
      const canvas = container.querySelector('canvas');
      if (canvas && canvas.chart) {
        canvas.chart.resize(); // Force chart to recalculate its layout
      }
    });
  }, 100);
}

function destroyAllCharts() {
  if (categoryChartInstance) {
    categoryChartInstance.destroy();
    categoryChartInstance = null;
  }
  
  if (subcategoryChartInstance) {
    subcategoryChartInstance.destroy();
    subcategoryChartInstance = null;
  }
  
  if (trendChartInstance) {
    trendChartInstance.destroy();
    trendChartInstance = null;
  }
}

// Function to create subcategory chart
function createSubcategoryChart(subcategoryData) {
  const ctx = document.getElementById('subcategoryChart').getContext('2d');
  
  const subcategories = Object.keys(subcategoryData);
  const successRates = subcategories.map(sub => subcategoryData[sub].successRate);
  
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: subcategories,
      datasets: [{
        label: 'Success Rate (%)',
        data: successRates,
        backgroundColor: 'rgba(76, 175, 80, 0.7)',
        borderColor: 'rgba(76, 175, 80, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      scales: {
        x: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Success Rate (%)'
          }
        }
      }
    }
  });
}

// Function to create trend chart
function createTrendChart(trendData) {
  const ctx = document.getElementById('trendChart').getContext('2d');
  
  const dates = trendData.map(item => item.date);
  const successRates = trendData.map(item => 
    item.total > 0 ? (item.correct / item.total) * 100 : 0
  );
  
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Daily Success Rate (%)',
        data: successRates,
        fill: false,
        borderColor: 'rgba(156, 39, 176, 1)',
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: {
            display: true,
            text: 'Success Rate (%)'
          }
        }
      }
    }
  });
}

</script>

</body>
</html>
